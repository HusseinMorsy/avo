<%
  fields_by_panel = {}
  @resource[:fields].each do |field|
    fields_by_panel[field[:panel_name]] ||= []
    fields_by_panel[field[:panel_name]].push(field)
    # [field[:panel_name], {fields: field}]
  end
  has_many_relations = @resource[:fields].select do |field|
    [:has_and_belongs_to_many, :has_many].include? field[:relationship]
  end
%>

<%= has_many_relations.inspect %>

<%= @resource[:panels].inspect %>

<div :resource-id="resourceId">
  <% @resource[:panels].each do |resource_panel| %>
    <%= panel do %>
      <% content_for :heading do %>
        <%= @heading %>
      <% end %>

      <% content_for :tools do %>
        <div class="flex justify-end space-x-2">
          <% back_path = params[:via_resource_name].present? ? resource_path(to_resource_name: params[:via_resource_name], to_resource_id: params[:via_resource_id], keep_query_params: false) : resources_path(@model.class) %>
          <%= a_link back_path do %>
            <%= svg 'media/svgs/arrow-left.svg' %> <%= t('avo.go_back') %>
          <% end %>
          <%= a_link resource_path(@model), color: 'red', variant: 'outlined', method: :delete, data: {confirm: 'Are you sure?'} do %>
            <%= svg 'media/svgs/trash.svg' %> <%= t('avo.delete').capitalize %>
          <% end if @authorization.set_record(@model).authorize_action :destroy, raise_exception: false %>
          <%= a_link edit_resource_path(@model), color: 'indigo' do %>
            <%= svg 'media/svgs/edit.svg' %> <%= t('avo.edit').capitalize %>
          <% end if @authorization.set_record(@model).authorize_action :edit, raise_exception: false %>
        </div>
      <% end %>

      <% fields_by_panel[resource_panel[:name]].each_with_index do |field, index| %>
        <%= show_field field, index, @resource %>
      <% end %>
    <% end %>
  <% end %>

  <div>
    <% has_many_relations.each_with_index do |field, index| %>
      <%= show_field field, index, @resource %>
    <% end %>
    <%#= has many panel %>
  </div>
</div>

<pre>
<%= JSON.pretty_generate(JSON.parse(@resource.to_json)) %>
</pre>
